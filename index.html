<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青春交換所 | 公開募集中</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .story-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeInLeft 1s ease-out;
        }

        .submission-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeInRight 1s ease-out;
        }

        .section-title {
            color: #764ba2;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .story-description {
            line-height: 1.8;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .collection-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .collection-list h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .collection-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .collection-item:last-child {
            border-bottom: none;
        }

        .collection-item::before {
            content: "♡";
            color: #ff6b6b;
            font-size: 1.2rem;
            margin-right: 10px;
        }

        .memory-wall {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .memory-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .memory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .memory-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
        }

        .memory-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .memory-content {
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
        }

        .reaction-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .reaction-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .reaction-btn.heart {
            background: #ff6b6b;
            color: white;
        }

        .reaction-btn.relate {
            background: #4ecdc4;
            color: white;
        }

        .reaction-btn.warm {
            background: #ffa726;
            color: white;
        }

        .reaction-btn:hover {
            transform: scale(1.05);
        }

        .reaction-count {
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .submit-form {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 25px;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .submit-btn {
            background: #ff6b6b;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .submit-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .floating-hearts {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
        }

        .floating-heart {
            position: absolute;
            color: #ff6b6b;
            font-size: 20px;
            animation: floatUp 3s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .memory-wall {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>青春交換所</h1>
            <p class="subtitle">公開募集中 ♡</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="storyCount">42</div>
                <div class="stat-label">青春故事</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="objectCount">28</div>
                <div class="stat-label">珍藏物件</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="secretCount">31</div>
                <div class="stat-label">秘密心事</div>
            </div>
        </div>

        <div class="main-content">
            <div class="story-section">
                <h2 class="section-title">那些青春的片段</h2>
                <div class="story-description">
                    那些你藏了很久卻還沒好好說完的青春故事，能不能借我們分享！
                    <br><br>
                    畢業季進行中的現在，青春也準備打包離開。我們想邀請你把那段年少時光留下來 ♡
                </div>
                
                <div class="collection-list">
                    <h3>我們正在募集：</h3>
                    <div class="collection-item">一個你想分享的「青春物件」與它的故事</div>
                    <div class="collection-item">那些曾經寫過卻沒傳出去的話</div>
                    <div class="collection-item">校園時期的遺憾、笑話、愛戀、意外</div>
                    <div class="collection-item">不敢說的祕密</div>
                    <div class="collection-item">任何你願意交換的青春記憶</div>
                </div>
            </div>

            <div class="submission-section">
                <h2 class="section-title">分享你的青春</h2>
                <form class="submit-form" id="submitForm">
                    <div class="form-group">
                        <label for="storyType">故事類型</label>
<select id="storyType" name="storyType">
    <option value="">選擇一個類型...</option>
    <option value="初戀回憶">初戀回憶</option>
    <option value="友情歲月">友情歲月</option>
    <option value="青春秘密">青春秘密</option>
    <option value="遺憾往事">遺憾往事</option>
    <option value="珍藏物件">珍藏物件</option>
    <option value="其他">其他</option>
</select>

                    </div>
                    
                    <div class="form-group">
                        <label for="storyTitle">給你的故事一個標題</label>
                        <input type="text" id="storyTitle" name="storyTitle" placeholder="例如：那條永遠沒還的髮圈...">
                    </div>
                    
                    <div class="form-group">
                        <label for="storyContent">你的青春故事</label>
                        <textarea id="storyContent" name="storyContent" placeholder="告訴我們這個故事吧..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="nickname">匿名暱稱（可選）</label>
                        <input type="text" id="nickname" name="nickname" placeholder="例如：永遠的17歲">
                    </div>
                    
                    <button type="submit" class="submit-btn">交換我的青春 ♡</button>
                </form>
            </div>
        </div>

        <div class="memory-wall" id="memoryWall">
            <!-- 青春記憶卡片會在這裡動態生成 -->
        </div>
    </div>

    <div class="floating-hearts" id="floatingHearts"></div>

    <script>
        // Airtable 設定
        const AIRTABLE_CONFIG = {
            baseId: 'appEz6VXIIpZ2KTfC', // 需要替換成你的 Airtable Base ID
            apiKey: 'patezBdct7FwZehDI.43be2550062e7e18583319c466ab0e681935beb1ee71c8f4c94f8eb7c874c7e3', // 需要替換成你的 Airtable API Key
            tableName: 'YouthStories' // 資料表名稱
        };

        // 全域變數
        let memories = [];
        let isLoading = false;

        // 示例記憶數據（作為預設顯示）
        const sampleMemories = [
            {
                id: 'sample1',
                type: "初戀回憶",
                title: "那條永遠沒還的髮圈",
                content: "高三的時候，暗戀的女孩借了我一條髮圈，說頭髮太長會擋住視線。我一直想找機會還給她，但總是錯過時機。現在這條髮圈還在我的抽屜裡，成了我青春最珍貴的回憶。",
                reactions: { heart: 15, relate: 23, warm: 8 }
            },
            {
                id: 'sample2',
                type: "友情歲月", 
                title: "永遠的放學後",
                content: "每天放學後，我們三個人總是會在學校門口的小攤販買個雞蛋糕，然後一起走路回家。那時候覺得這樣的日子會永遠持續下去，沒想到畢業後大家都各奔東西了。",
                reactions: { heart: 28, relate: 41, warm: 19 }
            },
            {
                id: 'sample3',
                type: "青春秘密",
                title: "藏在課本裡的紙條",
                content: "國中時寫了一張紙條想要給喜歡的人，但一直沒有勇氣交出去。那張紙條我夾在數學課本裡面，每次翻到都會心跳加速。直到現在，我都不知道如果當時交出去會是什麼結果。",
                reactions: { heart: 31, relate: 37, warm: 12 }
            },
            {
                id: 'sample4',
                type: "遺憾往事",
                title: "那場沒參加的畢業旅行",
                content: "高三的畢業旅行，因為家裡經濟狀況不允許而沒有參加。看著同學們在社群媒體上分享照片，心裡既羨慕又難過。現在想想，那些回憶是買不回來的。",
                reactions: { heart: 22, relate: 18, warm: 25 }
            },
            {
                id: 'sample5',
                type: "珍藏物件",
                title: "褪色的電影票根",
                content: "和初戀一起看的第一部電影票根，我一直保存到現在。雖然上面的字已經褪色到看不清楚，但每次看到它，都會想起那個下午的陽光和她的笑容。",
                reactions: { heart: 35, relate: 29, warm: 16 }
            },
            {
                id: 'sample6',
                type: "初戀回憶",
                title: "樓梯間的告白",
                content: "高二的時候，鼓起勇氣在樓梯間跟喜歡的人告白。雖然被拒絕了，但那種勇敢的感覺，還有心跳快到要跳出來的緊張，現在想起來都覺得很珍貴。",
                reactions: { heart: 18, relate: 24, warm: 13 }
            }
        ];

        // Airtable API 函數
        async function fetchStoriesFromAirtable() {
            // 如果沒有設定 API Key，使用示例資料
            if (AIRTABLE_CONFIG.apiKey === 'YOUR_API_KEY') {
                console.log('使用示例資料（請設定 Airtable API Key 以使用真實資料）');
                return sampleMemories;
            }

            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('無法從 Airtable 獲取資料');
                }

                const data = await response.json();
                
                return data.records.map(record => ({
                    id: record.id,
                    type: record.fields['Story Type'] || '其他',
                    title: record.fields['Title'] || '無標題',
                    content: record.fields['Content'] || '',
                    nickname: record.fields['Nickname'] || '匿名',
                    reactions: {
                        heart: record.fields['Heart Count'] || 0,
                        relate: record.fields['Relate Count'] || 0,
                        warm: record.fields['Warm Count'] || 0
                    },
                    timestamp: record.fields['Timestamp']
                }));
            } catch (error) {
                console.error('載入故事失敗:', error);
                return sampleMemories; // 發生錯誤時返回示例資料
            }
        }

async function submitStoryToAirtable(storyData) {
    if (AIRTABLE_CONFIG.apiKey === 'YOUR_API_KEY') {
        console.log('模擬提交到 Airtable:', storyData);
        return {
            id: 'local_' + Date.now(),
            ...storyData,
            reactions: { heart: 0, relate: 0, warm: 0 }
        };
    }

    try {
        // 🔍 加在這裡！
        console.log('送出到 Airtable 的內容:', {
            'Name': `${storyData.type}｜${storyData.title || '無標題'}`,
            '故事類型': storyData.type,
            '標題': storyData.title,
            '內容': storyData.content,
            '匿名暱稱': storyData.nickname || '匿名',
            '心動♡數量': 0,
            '我也是': 0,
            '好溫暖': 0,
            'Timestamp': new Date().toISOString()
        });

        const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fields: {
                    'Name': `${storyData.type}｜${storyData.title || '無標題'}`,
                    '故事類型': storyData.type,
                    '標題': storyData.title,
                    '內容': storyData.content,
                    '匿名暱稱': storyData.nickname || '匿名',
                    '心動♡數量': 0,
                    '我也是': 0,
                    '好溫暖': 0,
                    'Timestamp': new Date().toISOString()
                }
            })
        });

        if (!response.ok) {
                const errorDetail = await response.json(); // << 加這行
    console.error('Airtable 回傳錯誤內容:', errorDetail); // << 以及這行
            throw new Error('無法提交到 Airtable');
        }

        const data = await response.json();
        return {
            id: data.id,
            ...storyData,
            reactions: { heart: 0, relate: 0, warm: 0 }
        };
    } catch (error) {
        console.error('提交失敗:', error);
        throw error;
    }
}



   async function updateReactionInAirtable(storyId, reactionType, newCount) {
    if (AIRTABLE_CONFIG.apiKey === 'YOUR_API_KEY' || storyId.startsWith('sample') || storyId.startsWith('local_')) {
        console.log('模擬更新反應:', storyId, reactionType, newCount);
        return;
    }

    try {
        const fieldName = reactionType === 'heart' ? '心動♡數量' :
                          reactionType === 'relate' ? '我也是' : '好溫暖';

        const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${storyId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fields: {
                    [fieldName]: newCount
                }
            })
        });

        if (!response.ok) {
            throw new Error('無法更新反應');
        }
    } catch (error) {
        console.error('更新反應失敗:', error);
    }
}


        // 生成記憶卡片
        function createMemoryCard(memory, index) {
            const card = document.createElement('div');
            card.className = 'memory-card';
            card.innerHTML = `
                <div class="memory-tag">${memory.type}</div>
                <h3 style="margin-bottom: 10px; color: #333;">${memory.title}</h3>
                <div class="memory-content">${memory.content}</div>
                ${memory.nickname && memory.nickname !== '匿名' ? `<div style="font-size: 0.9rem; color: #888; margin-top: 10px;">by ${memory.nickname}</div>` : ''}
                <div class="reaction-buttons">
                    <button class="reaction-btn heart" onclick="addReaction('${memory.id}', ${index}, 'heart')">
                        ♡ <span class="reaction-count">${memory.reactions.heart}</span>
                    </button>
                    <button class="reaction-btn relate" onclick="addReaction('${memory.id}', ${index}, 'relate')">
                        我也是 <span class="reaction-count">${memory.reactions.relate}</span>
                    </button>
                    <button class="reaction-btn warm" onclick="addReaction('${memory.id}', ${index}, 'warm')">
                        好溫暖 <span class="reaction-count">${memory.reactions.warm}</span>
                    </button>
                </div>
            `;
            return card;
        }

        // 添加反應
        async function addReaction(storyId, index, type) {
            const button = event.target.closest('.reaction-btn');
            
            // 防止重複點擊
            if (button.disabled) return;
            button.disabled = true;
            
            try {
                memories[index].reactions[type]++;
                const newCount = memories[index].reactions[type];
                
                // 更新到 Airtable
                await updateReactionInAirtable(storyId, type, newCount);
                
                // 更新UI
                updateMemoryWall();
                createFloatingHeart(button);
                
                // 顯示成功提示
                showToast('感謝你的回應！♡');
            } catch (error) {
                // 如果更新失敗，回復原狀
                memories[index].reactions[type]--;
                updateMemoryWall();
                showToast('回應失敗，請稍後再試', 'error');
            } finally {
                button.disabled = false;
            }
        }

        // 創建浮動愛心
        function createFloatingHeart(element) {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.innerHTML = '♡';
            heart.style.left = element.offsetLeft + 'px';
            heart.style.top = element.offsetTop + 'px';
            
            document.getElementById('floatingHearts').appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 3000);
        }

        // 更新記憶牆
        function updateMemoryWall() {
            const memoryWall = document.getElementById('memoryWall');
            memoryWall.innerHTML = '';
            
            if (memories.length === 0) {
                memoryWall.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">載入中...</div>';
                return;
            }
            
            memories.forEach((memory, index) => {
                const card = createMemoryCard(memory, index);
                memoryWall.appendChild(card);
            });
        }

        // 處理表單提交
        document.getElementById('submitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('.submit-btn');
            const originalText = submitButton.textContent;
            
            // 防止重複提交
            if (submitButton.disabled) return;
            submitButton.disabled = true;
            submitButton.textContent = '提交中...';
            
            try {
                const formData = new FormData(this);
                const storyData = {
                    type: formData.get('storyType') || '其他',
                    title: formData.get('storyTitle') || '無標題',
                    content: formData.get('storyContent'),
                    nickname: formData.get('nickname') || '匿名'
                };
                
                if (!storyData.content.trim()) {
                    throw new Error('請填寫你的青春故事');
                }
                
                // 提交到 Airtable
                const newMemory = await submitStoryToAirtable(storyData);
                
                // 添加到本地顯示
                memories.unshift(newMemory);
                updateMemoryWall();
                updateStats();
                
                // 重置表單
                this.reset();
                
                // 顯示成功訊息
                showToast('感謝你分享青春故事！♡', 'success');
                
            } catch (error) {
                console.error('提交失敗:', error);
                showToast(error.message || '提交失敗，請稍後再試', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // 顯示提示訊息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#4CAF50' : 
                           type === 'error' ? '#f44336' : '#2196F3';
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                background: ${bgColor};
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 載入故事
        async function loadStories() {
            try {
                showLoadingState();
                memories = await fetchStoriesFromAirtable();
                updateMemoryWall();
                updateStats();
            } catch (error) {
                console.error('載入故事失敗:', error);
                showToast('載入故事失敗，請重新整理頁面', 'error');
            }
        }

        // 顯示載入狀態
        function showLoadingState() {
            const memoryWall = document.getElementById('memoryWall');
            memoryWall.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">💭</div>
                    <div>正在載入青春故事...</div>
                </div>
            `;
        }

        // 更新統計數據
        function updateStats() {
            document.getElementById('storyCount').textContent = memories.length;
            document.getElementById('objectCount').textContent = memories.filter(m => m.type === '珍藏物件').length + 28;
            document.getElementById('secretCount').textContent = memories.filter(m => m.type === '青春秘密').length + 31;
        }

        // 頁面加載時初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 載入故事
            loadStories();
            
            // 添加CSS動畫
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // 添加滾動效果
            window.addEventListener('scroll', function() {
                const cards = document.querySelectorAll('.memory-card');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    if (rect.top < window.innerHeight && rect.bottom > 0) {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }
                });
            });
            
            // 設定提示（如果使用示例資料）
            if (AIRTABLE_CONFIG.apiKey === 'YOUR_API_KEY') {
                setTimeout(() => {
                    showToast('目前使用示例資料，請設定 Airtable 以啟用真實資料庫功能', 'info');
                }, 2000);
            }
        });
    </script>
</body>
</html>
